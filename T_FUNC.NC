O0001
(MACRO CAMBIO DE HERRAMIENTA - TORRETA 12 POSICIONES)
(========================================================)
(  T_FUNC.NC - MACRO DE CAMBIO DE HERRAMIENTA           )
(  Controlador: ADTECH CNC9620 / Panel: FCNC4M          )
(  Torreta: 12 posiciones con codificacion BCD           )
(  Traducido y documentado en espanol                    )
(========================================================)
(                                                        )
(  FLUJO DEL PROGRAMA:                                   )
(  1. Validar parametros #400 y #200                     )
(  2. Desclampear torreta y liberar freno                )
(  3. Calcular ruta optima CW/CCW                        )
(  4. Rotar torreta posicion por posicion                )
(  5. Clampear torreta y activar freno                   )
(  6. Verificar codigo BCD de posicion final             )
(                                                        )
(  VARIABLES CLAVE:                                      )
(  #200       = Herramienta destino 1-12                 )
(  #201       = Posicion actual extraida de #4120        )
(  #202       = Distancia calculada al destino           )
(  #400       = Maximo de herramientas configuradas      )
(  #4120      = T-word actual, posicion x100             )
(  #1402      = Rele motor torreta CW - OUT08            )
(  #1403      = Rele motor torreta CCW - OUT09           )
(  #1422      = Rele liberacion freno torreta            )
(  #1423      = Rele clamp/unclamp torreta               )
(  #1005-#1008 = Sensores BCD torreta IN5-IN8            )
(  #11028     = Idioma alarmas: 0=ingles, 1=chino        )
(  #33        = Marca de direccion: 1=CW, -1=CCW         )
(  #100       = Contador de posicion durante rotacion     )
(                                                        )
(  M88 = Macro de verificacion con timeout               )
(  Formato: M88 P[senal] L[valor] Q[timeout_ms]         )
(  P=numero de entrada/sensor, L=valor esperado,         )
(  Q=timeout en milisegundos, 5000=5seg                  )
(                                                        )
(========================================================)
(                                                        )
(          TABLA DE SECCIONES DEL PROGRAMA               )
(                                                        )
(========================================================)
(                                                        )
(  SECCION 1 | Validacion de parametros                  )
(            | Verifica #400 y #200 antes de mover       )
(                                                        )
(  SECCION 2 | Desclampeo de torreta                     )
(            | Libera freno, desclampea, verifica         )
(                                                        )
(  SECCION 3 | Calculo de ruta optima CW/CCW             )
(            | Determina direccion mas corta             )
(                                                        )
(  SECCION 4 | Bucle de rotacion                         )
(            | Gira posicion por posicion con sensor      )
(                                                        )
(  SECCION 5 | Clampeo post-rotacion                     )
(            | Apaga motores, clampea, activa freno       )
(                                                        )
(  SECCION 6 | Verificacion BCD T1-T12                   )
(            | Confirma posicion via 4 sensores BCD       )
(                                                        )
(========================================================)
(                                                        )
(  TABLA BCD DE HERRAMIENTAS                             )
(  Formula: valor_BCD = 15 - numero_herramienta          )
(  Sensores: TP4=IN5=#1005 TP3=IN6=#1006                )
(            TP2=IN7=#1007 TP1=IN8=#1008                 )
(                                                        )
(  T1  = 1110 =14    T7  = 1000 =8                      )
(  T2  = 1101 =13    T8  = 0111 =7                      )
(  T3  = 1100 =12    T9  = 0110 =6                      )
(  T4  = 1011 =11    T10 = 0101 =5                      )
(  T5  = 1010 =10    T11 = 0100 =4                      )
(  T6  = 1001 =9     T12 = 0011 =3                      )
(                                                        )
(========================================================)
(  FIN DE TABLA - INICIO DEL PROGRAMA                    )
(========================================================)

(********************************************************)
(*                                                      *)
(*   SECCION 1: VALIDACION DE PARAMETROS                *)
(*                                                      *)
(*   Verifica que el sistema tenga configurado un       *)
(*   numero valido de herramientas #400 y que la        *)
(*   herramienta solicitada #200 este en rango.         *)
(*                                                      *)
(*   #400    = Max herramientas configuradas, 1-12      *)
(*   #200    = Herramienta destino solicitada           *)
(*   #11028  = Idioma para mensajes de alarma           *)
(*   #3000=1 = Dispara alarma con mensaje en pantalla   *)
(*                                                      *)
(********************************************************)

IF[#400==0] M30(Si no hay herramientas configuradas, salir)
IF [[#400 <= 0] || [#400>12]]
{
IF [#11028==1] THEN #3000=1(Error config. maximo herramientas del sistema)
IF [#11028==0] THEN #3000=1(Error config. maximo herramientas del sistema)
}
IF [[#200 > #400] || [#200 <=0 ]]
{
IF [#11028==1] THEN #3000=1(Error en numero de herramienta del codigo T)
IF [#11028==0] THEN #3000=1(Error en numero de herramienta del codigo T)
}

(********************************************************)
(*                                                      *)
(*   SECCION 2: DESCLAMPEO DE TORRETA                   *)
(*                                                      *)
(*   Secuencia: liberar freno -> desclampear -> esperar *)
(*   Verificacion triple con M88, timeout 5 seg:        *)
(*   - P23 L0 = senal unclamp confirmada                *)
(*   - P21 L1 = senal desclampeo verificada             *)
(*   - P22 L1 = senal freno liberado verificada         *)
(*                                                      *)
(*   #1422 = Rele liberacion freno torreta              *)
(*   #1423 = Rele unclamp torreta                       *)
(*                                                      *)
(********************************************************)

(Mapeo de sensores BCD: TP4=IN5, TP3=IN6, TP2=IN7, TP1=IN8)
(#200 = herramienta destino, #4120 = posicion actual x100)
#1422=1 (Liberar freno torreta)
#1423=1 (Desclampear torreta)
G4X1(Pausa de 1 segundo para estabilizar mecanismo)
M88P23L0Q5000 (Verificar senal de desclampeo)
M88P21L1Q5000 (Verificar desclampeo completado)
M88P22L1Q5000 (Verificar freno liberado)

(********************************************************)
(*                                                      *)
(*   SECCION 3: CALCULO DE RUTA OPTIMA CW/CCW          *)
(*                                                      *)
(*   Calcula la ruta mas corta considerando la          *)
(*   naturaleza circular de la torreta, 12 posiciones.  *)
(*                                                      *)
(*   #201 = Posicion actual = #4120 / 100               *)
(*   #202 = Distancia = destino - actual                *)
(*   Si distancia > 6: restar 12, ir por el otro lado   *)
(*   Si distancia < -6: sumar 12, ir por el otro lado   *)
(*   #33  = Marca de direccion: 1=CW, -1=CCW           *)
(*   #1402 = Motor torreta CW                           *)
(*   #1403 = Motor torreta CCW                          *)
(*                                                      *)
(********************************************************)

(Calcular ruta mas corta considerando naturaleza circular)
#201=#4120/100 (Extraer posicion actual de herramienta)
#202=#200-#201 (Calcular distancia directa al destino)

(Ajuste wrap-around para ruta mas corta)
IF[#202>6] THEN #202=#202-12
IF[#202<-6] THEN #202=#202+12

(Determinar direccion de rotacion segun ruta mas corta)
IF[#202>0]
{
#33=1 (Marca sentido horario CW)
#1402=1(Encender motor torreta CW)
}
ELSE
{
#33=-1 (Marca sentido antihorario CCW)
#1403=1(Encender motor torreta CCW)
}

(********************************************************)
(*                                                      *)
(*   SECCION 4: BUCLE DE ROTACION                       *)
(*                                                      *)
(*   Gira la torreta posicion por posicion usando       *)
(*   sensor de paso P15. Espera pulso alto y luego      *)
(*   bajo para contar cada posicion.                    *)
(*                                                      *)
(*   M88 P15 L1 = esperar sensor posicion ALTO          *)
(*   M88 P15 L0 = esperar sensor posicion BAJO          *)
(*   #100 = contador posicion actual durante giro       *)
(*   #33  = incremento por paso: +1=CW o -1=CCW        *)
(*   Wrap: si #100==0 -> 12, si #100==13 -> 1           *)
(*                                                      *)
(********************************************************)

#100=FIX[#4120/100](Posicion actual como entero)
WHILE[#200!=#100]DO88(Mientras no llegue al destino)
M88P15L1Q5000(Esperar sensor de posicion ALTO)
M88P15L0Q5000(Esperar sensor de posicion BAJO = paso completado)
#100=#100+#33(Avanzar contador segun direccion)
IF[#100==0]
{
#100=12(Wrap-around: de 0 volver a 12)
}
IF[#100==13]
{
#100=1(Wrap-around: de 13 volver a 1)
}
END88

(********************************************************)
(*                                                      *)
(*   SECCION 5: CLAMPEO POST-ROTACION                   *)
(*                                                      *)
(*   Secuencia: apagar motores -> clampear -> freno     *)
(*   Verificacion triple con M88, timeout 5 seg:        *)
(*   - P23 L0 = senal clampeo confirmada                *)
(*   - P21 L1 = senal clampeo verificada                *)
(*   - P22 L0 = senal freno activado verificada         *)
(*                                                      *)
(*   #1402 = Motor CW, #1403 = Motor CCW                *)
(*   #1423 = Rele clamp, #1422 = Rele freno             *)
(*                                                      *)
(********************************************************)

#1402=0 (Motor CW apagado)
#1403=0 (Motor CCW apagado)
#1423=0 (Clampear torreta)
G04 P1000 (Pausa 1000ms para asentamiento mecanico)
#1422=0 (Activar freno torreta)

M88P23L0Q5000 (Verificar senal de clampeo)
M88P21L1Q5000 (Verificar clampeo completado)
M88P22L0Q5000 (Verificar freno activado)

(********************************************************)
(*                                                      *)
(*   SECCION 6: VERIFICACION BCD T1-T12                 *)
(*                                                      *)
(*   Verifica que los 4 sensores BCD IN5-IN8            *)
(*   coincidan con el codigo esperado de la herramienta *)
(*   destino. Timeout de 8 segundos por posicion.       *)
(*                                                      *)
(*   Sensores BCD:                                      *)
(*   #1005 = IN5, TP4 - bit mas significativo           *)
(*   #1006 = IN6, TP3                                   *)
(*   #1007 = IN7, TP2                                   *)
(*   #1008 = IN8, TP1 - bit menos significativo         *)
(*                                                      *)
(*   Cada bloque: lee sensores en bucle con G4P10       *)
(*   pausa 10ms. Si coinciden, salta a etiqueta Nxx.    *)
(*   Si timeout 8000ms, el controlador genera alarma.   *)
(*                                                      *)
(*   TABLA BCD - recordatorio:                          *)
(*   T1=1110  T2=1101  T3=1100  T4=1011                *)
(*   T5=1010  T6=1001  T7=1000  T8=0111                *)
(*   T9=0110  T10=0101 T11=0100 T12=0011               *)
(*                                                      *)
(********************************************************)

(Verificacion BCD por calculo directo)
(Formula: valor BCD esperado = 15 - numero herramienta)
#20=15-#200
#21=#1005*8+#1006*4+#1007*2+#1008
#1=0
WHILE[#1<=8000]DO1
IF[#21==#20]GOTO1
G4P10
#1=#1+10
#21=#1005*8+#1006*4+#1007*2+#1008
END1
N1
IF[#21!=#20] THEN #3000=1(Error BCD verificacion herramienta)

(FIN DEL CAMBIO DE HERRAMIENTA)
M30

(========================================================)
(  FIN DE T_FUNC.NC                                      )
(  Programa O0001 - 6 secciones                          )
(  Torreta 12 posiciones con verificacion BCD            )
(========================================================)
